<nav class="navbar">
  <ul>
    <li>
      <a class="anime nav" href="#experiences" data-color="#f68dab"
        >Expériences</a
      >
    </li>
    <li>
      <a class="anime nav" href="#realisations" data-color="#66c384"
        >Réalisations</a
      >
    </li>
    <li>
      <a class="anime nav" href="#formations" data-color="#9c85d3">Formations</a
      >
    </li>
  </ul>
  <div class="indicator"></div>
</nav>

<script>
  import anime from "animejs";
  import { onScrollAndResize } from "@/lib/dom/onWindowEvent";
  import {
    createViewDetection,
    anchorsQueryToViewDetectionElement,
  } from "@/lib/dom/viewDetection";

  declare global {
    interface Window {
      heroAnimationCompleted: boolean;
    }
  }

  function initNavbar() {
    const navbar = document.querySelector(".navbar") as HTMLElement;
    const indicator = navbar.querySelector(".indicator") as HTMLElement;
    const ul = navbar.querySelector("ul") as HTMLElement;

    let isHovering = false;
    let activeLink: HTMLElement | null = null;
    let hoverTimeout: number | null = null;

    function moveIndicator(target: HTMLElement | null) {
      if (!target) {
        anime({ targets: indicator, opacity: 0, duration: 200, easing: "easeOutQuad" });
        return;
      }

      const rect = target.getBoundingClientRect();
      const navRect = navbar.getBoundingClientRect();

      indicator.style.setProperty("--indicator-color", target.dataset.color || "#f8ba88");
      anime({
        targets: indicator,
        left: rect.left - navRect.left,
        width: rect.width,
        opacity: 1,
        duration: 300,
        easing: "easeOutCubic",
      });
    }

    // Hover: show indicator on hovered link, return to active after 150ms
    ul.querySelectorAll("a").forEach((link) => {
      link.addEventListener("mouseenter", () => {
        if (hoverTimeout) clearTimeout(hoverTimeout);
        isHovering = true;
        moveIndicator(link as HTMLElement);
      });
    });

    ul.addEventListener("mouseleave", () => {
      isHovering = false;
      hoverTimeout = window.setTimeout(() => {
        if (!isHovering) moveIndicator(activeLink);
      }, 150);
    });

    // Scroll detection via viewDetection
    const targets = anchorsQueryToViewDetectionElement(".navbar a", {
      onInside: (anchor) => anchor.classList.add("current"),
      onOutside: (anchor) => anchor.classList.remove("current"),
    });

    const detect = createViewDetection(targets, {
      setBounds: (offset) => [offset + 100, offset - 100],
    });

    function checkVisibility() {
      detect();
      const newActive = navbar.querySelector("a.current") as HTMLElement | null;
      if (newActive !== activeLink) {
        activeLink = newActive;
        if (!isHovering) moveIndicator(activeLink);
      }
    }

    // Enable after hero animation
    function enable() {
      navbar.classList.add("enabled");
      onScrollAndResize(checkVisibility, "navbarDetection");
    }

    if (window.heroAnimationCompleted) {
      enable();
    } else {
      window.addEventListener("heroAnimationComplete", enable, { once: true });
    }
  }

  window.addEventListener("load", initNavbar);
</script>

<style>
  .navbar {
    position: relative;
    pointer-events: none;
  }

  .navbar.enabled {
    pointer-events: auto;
  }

  ul {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    margin: -8px;
  }

  li {
    opacity: 0;
  }

  a {
    display: block;
    padding: 16px 12px;
    font-size: 18px;
    font-weight: 200;
    color: var(--color);
    text-decoration: none;
    opacity: 0.6;
    transition: opacity 0.3s ease-in-out;
  }

  a:hover,
  a.current {
    opacity: 1;
  }

  a[data-color="#f68dab"].current {
    color: #f68dab;
  }
  a[data-color="#66c384"].current {
    color: #66c384;
  }
  a[data-color="#9c85d3"].current {
    color: #9c85d3;
  }

  .indicator {
    --indicator-color: #f8ba88;
    position: absolute;
    bottom: 8px;
    height: 2px;
    background: var(--indicator-color);
    border-radius: 1px;
    opacity: 0;
    pointer-events: none;
    box-shadow: 0 0 6px
      color-mix(in srgb, var(--indicator-color) 50%, transparent);
  }

  @media screen and (max-width: 980px) {
    .navbar {
      display: none;
    }
  }
</style>
