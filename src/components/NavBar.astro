<nav class="navbar">
  <ul>
    <li><a class="anime nav" href="#experiences" data-color="#f68dab">Expériences</a></li>
    <li><a class="anime nav" href="#realisations" data-color="#66c384">Réalisations</a></li>
    <li><a class="anime nav" href="#formations" data-color="#9c85d3">Formations</a></li>
  </ul>
  <div class="indicator"></div>
</nav>

<script>
  import anime from "animejs";

  declare global {
    interface Window {
      heroAnimationCompleted: boolean;
    }
  }

  function initNavbar() {
    const navbar = document.querySelector(".navbar") as HTMLElement;
    const indicator = document.querySelector(".navbar .indicator") as HTMLElement;
    const links = document.querySelectorAll(".navbar a") as NodeListOf<HTMLElement>;
    const ul = navbar.querySelector("ul") as HTMLElement;

    let activeSection: string | null = null;
    let isHovering = false;
    let pendingUpdate: number | null = null;
    let isEnabled = false;
    let hoverTimeout: number | null = null;

    function setIndicatorColor(color: string) {
      indicator.style.setProperty("--indicator-color", color);
    }

    function updateIndicator(target: HTMLElement | null, immediate = false) {
      if (!isEnabled) return;

      if (!target) {
        anime({
          targets: indicator,
          opacity: 0,
          duration: immediate ? 0 : 200,
          easing: "easeOutQuad",
        });
        return;
      }

      const rect = target.getBoundingClientRect();
      const navRect = navbar.getBoundingClientRect();
      const color = target.dataset.color || "#f8ba88";

      setIndicatorColor(color);

      anime({
        targets: indicator,
        left: rect.left - navRect.left,
        width: rect.width,
        opacity: 1,
        duration: immediate ? 0 : 300,
        easing: "easeOutCubic",
      });
    }

    function getActiveLink(): HTMLElement | null {
      if (!activeSection) return null;
      return navbar.querySelector(`a[href="#${activeSection}"]`);
    }

    // Hover handling on individual links
    links.forEach((link) => {
      link.addEventListener("mouseenter", () => {
        if (!isEnabled) return;
        if (hoverTimeout) {
          clearTimeout(hoverTimeout);
          hoverTimeout = null;
        }
        isHovering = true;
        updateIndicator(link);
      });
    });

    // Use the ul container for mouseleave to have bigger detection area
    ul.addEventListener("mouseleave", () => {
      if (!isEnabled) return;
      isHovering = false;
      // Longer delay before returning to current section
      hoverTimeout = window.setTimeout(() => {
        if (!isHovering) {
          updateIndicator(getActiveLink());
        }
      }, 150);
    });

    // Scroll detection
    function detectActiveSection() {
      if (!isEnabled) return;

      const sections = ["experiences", "realisations", "formations"];
      const offset = window.innerHeight / 2;

      let newActive: string | null = null;

      for (const id of sections) {
        const section = document.getElementById(id);
        if (!section) continue;

        const rect = section.getBoundingClientRect();
        if (rect.top <= offset && rect.bottom >= offset) {
          newActive = id;
          break;
        }
      }

      if (newActive !== activeSection) {
        links.forEach((link) => {
          const href = link.getAttribute("href");
          if (href === `#${newActive}`) {
            link.classList.add("current");
          } else {
            link.classList.remove("current");
          }
        });

        activeSection = newActive;

        if (!isHovering) {
          updateIndicator(getActiveLink());
        }
      }
    }

    // Throttled scroll handler
    function onScroll() {
      if (!isEnabled || pendingUpdate) return;
      pendingUpdate = requestAnimationFrame(() => {
        detectActiveSection();
        pendingUpdate = null;
      });
    }

    // Enable after hero animation completes
    function enable() {
      isEnabled = true;
      navbar.classList.add("enabled");
      detectActiveSection();
    }

    window.addEventListener("scroll", onScroll, { passive: true });
    window.addEventListener("resize", detectActiveSection);

    // Check if hero animation already completed (e.g., page was scrolled)
    if (window.heroAnimationCompleted) {
      enable();
    } else {
      window.addEventListener("heroAnimationComplete", enable, { once: true });
    }
  }

  window.addEventListener("load", initNavbar);
</script>

<style>
  .navbar {
    position: relative;
    pointer-events: none;
  }

  .navbar.enabled {
    pointer-events: auto;
  }

  ul {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    margin: -8px;
  }

  li {
    opacity: 0;
  }

  a {
    display: block;
    padding: 16px 12px;
    font-size: 18px;
    font-weight: 200;
    color: var(--color);
    text-decoration: none;
    opacity: 0.6;
    transition: opacity 0.3s ease-in-out;
  }

  a:hover,
  a.current {
    opacity: 1;
  }

  a[data-color="#f68dab"].current { color: #f68dab; }
  a[data-color="#66c384"].current { color: #66c384; }
  a[data-color="#9c85d3"].current { color: #9c85d3; }

  .indicator {
    --indicator-color: #f8ba88;
    position: absolute;
    bottom: 8px;
    height: 2px;
    background: var(--indicator-color);
    border-radius: 1px;
    opacity: 0;
    pointer-events: none;
    box-shadow: 0 0 6px color-mix(in srgb, var(--indicator-color) 50%, transparent);
  }

  @media screen and (max-width: 980px) {
    .navbar {
      display: none;
    }
  }
</style>
