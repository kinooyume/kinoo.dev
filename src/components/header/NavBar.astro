---
export interface NavItem {
  label: string;
  href: string;
  color: string;
}

interface Props {
  items?: NavItem[];
}

const defaultItems: NavItem[] = [
  { label: "Expériences", href: "/#experiences", color: "#f68dab" },
  { label: "Réalisations", href: "/#realisations", color: "#66c384" },
  { label: "Formations", href: "/#formations", color: "#9c85d3" },
];

const { items = defaultItems } = Astro.props;
---

<nav class="navbar">
  <ul>
    {
      items.map((item) => (
        <li>
          <a class="anime nav" href={item.href} data-color={item.color}>
            {item.label}
          </a>
        </li>
      ))
    }
  </ul>
  <div class="indicator"></div>
</nav>

<script>
  import anime from "animejs";
  import { onScrollAndResize } from "@/lib/dom/onWindowEvent";
  import {
    createViewDetection,
    anchorsQueryToViewDetectionElement,
  } from "@/lib/dom/viewDetection";
  import { onHeroAnimationComplete } from "@/lib/animations/onHeroAnimationComplete";

  function initNavbar() {
    const navbarEl = document.querySelector(".navbar");
    if (!navbarEl) return;
    const navbar = navbarEl as HTMLElement;
    const indicator = navbar.querySelector(".indicator") as HTMLElement;
    const ul = navbar.querySelector("ul") as HTMLElement;

    let isHovering = false;
    let activeLink: HTMLElement | null = null;
    let hoverTimeout: number | null = null;
    let currentAnim: anime.AnimeInstance | null = null;

    function moveIndicator(target: HTMLElement | null) {
      if (currentAnim) {
        currentAnim.pause();
        currentAnim = null;
      }

      if (!target) {
        currentAnim = anime({
          targets: indicator,
          opacity: 0,
          duration: 200,
          easing: "easeOutQuad",
        });
        return;
      }

      const rect = target.getBoundingClientRect();
      const navRect = navbar.getBoundingClientRect();

      indicator.style.setProperty(
        "--indicator-color",
        target.dataset.color || "#f8ba88",
      );
      currentAnim = anime({
        targets: indicator,
        left: rect.left - navRect.left,
        width: rect.width,
        opacity: 1,
        duration: 300,
        easing: "easeOutCubic",
      });
    }

    ul.querySelectorAll("a").forEach((link) => {
      link.addEventListener("mouseenter", () => {
        if (hoverTimeout) clearTimeout(hoverTimeout);
        isHovering = true;
        moveIndicator(link as HTMLElement);
      });
    });

    ul.addEventListener("mouseleave", () => {
      isHovering = false;
      hoverTimeout = window.setTimeout(() => {
        if (!isHovering) moveIndicator(activeLink);
      }, 150);
    });

    const targets = anchorsQueryToViewDetectionElement(".navbar a", {
      onInside: (anchor) => anchor.classList.add("current"),
      onOutside: (anchor) => anchor.classList.remove("current"),
    });

    const detect = createViewDetection(targets, {
      setBounds: (offset) => [offset + 100, offset - 100],
    });

    function checkVisibility() {
      detect();
      const newActive = navbar.querySelector("a.current") as HTMLElement | null;
      if (newActive !== activeLink) {
        activeLink = newActive;
        if (!isHovering) moveIndicator(activeLink);
      }
    }

    function enable() {
      navbar.classList.add("enabled");
      onScrollAndResize(checkVisibility, "navbarDetection");
    }

    const hasHero = !!document.getElementById("hero");
    if (hasHero) {
      onHeroAnimationComplete(enable);
    } else {
      enable();
    }
  }

  window.addEventListener("load", initNavbar);
</script>

<style>
  .navbar {
    position: relative;
    pointer-events: none;
  }

  .navbar.enabled {
    pointer-events: auto;
  }

  ul {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px;
    margin: -8px;
  }

  a {
    display: block;
    padding: 16px 12px;
    font-size: 18px;
    font-weight: 200;
    color: var(--color);
    text-decoration: none;
    opacity: 0.6;
    transition: opacity 0.3s ease-in-out, transform 0.3s ease;
  }

  a:hover,
  a.current {
    opacity: 1;
  }

  a[data-color="#f68dab"].current {
    color: #f68dab;
  }
  a[data-color="#66c384"].current {
    color: #66c384;
  }
  a[data-color="#9c85d3"].current {
    color: #9c85d3;
  }

  .indicator {
    --indicator-color: #f8ba88;
    position: absolute;
    bottom: 8px;
    height: 2px;
    background: var(--indicator-color);
    border-radius: 1px;
    opacity: 0;
    pointer-events: none;
    box-shadow: 0 0 6px
      color-mix(in srgb, var(--indicator-color) 50%, transparent);
  }

  @media screen and (max-width: 1100px) {
    .navbar {
      display: none;
    }
  }
</style>
